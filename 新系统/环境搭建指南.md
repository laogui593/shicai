# 彩票系统环境搭建指南

## 🖥️ **系统环境要求**

### 操作系统
- **Linux**: Ubuntu 18.04+, CentOS 7+, Debian 9+
- **Windows**: Windows 10+, Windows Server 2016+
- **macOS**: macOS 10.14+

### 核心环境
- **PHP**: >= 8.0 (推荐 PHP 8.1 或 8.2)
- **MySQL**: >= 5.7 (推荐 MySQL 8.0)
- **Web服务器**: Nginx 1.18+ 或 Apache 2.4+
- **Composer**: 最新版本

## 📦 **环境安装步骤**

### 1. 安装 PHP 8.0+

#### Ubuntu/Debian:
```bash
# 添加PHP源
sudo apt update
sudo add-apt-repository ppa:ondrej/php
sudo apt update

# 安装PHP 8.1及扩展
sudo apt install php8.1 php8.1-fpm php8.1-cli php8.1-common php8.1-mysql \
php8.1-zip php8.1-gd php8.1-mbstring php8.1-curl php8.1-xml php8.1-bcmath \
php8.1-json php8.1-openssl php8.1-pdo php8.1-tokenizer php8.1-fileinfo

# 验证安装
php -v
```

#### CentOS/RHEL:
```bash
# 安装Remi源
sudo yum install epel-release yum-utils
sudo yum install http://rpms.remirepo.net/enterprise/remi-release-8.rpm
sudo yum-config-manager --enable remi-php81

# 安装PHP
sudo yum install php php-fpm php-cli php-common php-mysqlnd php-zip \
php-gd php-mbstring php-curl php-xml php-bcmath php-json php-openssl \
php-pdo php-tokenizer php-fileinfo

php -v
```

#### Windows:
```bash
# 下载PHP 8.1 Windows版本
https://windows.php.net/download/

# 解压到 C:\php
# 配置环境变量
# 复制 php.ini-development 为 php.ini
# 启用必要扩展
```

### 2. 安装 MySQL 8.0

#### Ubuntu/Debian:
```bash
# 安装MySQL
sudo apt update
sudo apt install mysql-server

# 安全配置
sudo mysql_secure_installation

# 启动服务
sudo systemctl start mysql
sudo systemctl enable mysql
```

#### CentOS/RHEL:
```bash
# 安装MySQL
sudo yum install mysql-server

# 启动服务
sudo systemctl start mysqld
sudo systemctl enable mysqld

# 获取临时密码
sudo grep 'temporary password' /var/log/mysqld.log
```

### 3. 安装 Nginx

#### Ubuntu/Debian:
```bash
sudo apt install nginx
sudo systemctl start nginx
sudo systemctl enable nginx
```

#### CentOS/RHEL:
```bash
sudo yum install nginx
sudo systemctl start nginx
sudo systemctl enable nginx
```

### 4. 安装 Composer

```bash
# 下载并安装Composer
curl -sS https://getcomposer.org/installer | php
sudo mv composer.phar /usr/local/bin/composer

# 验证安装
composer --version
```

## 🔧 **系统配置**

### 1. PHP配置 (php.ini)

```ini
# 基本配置
memory_limit = 256M
max_execution_time = 300
max_input_time = 300
upload_max_filesize = 50M
post_max_size = 50M

# 扩展配置
extension=mysqli
extension=pdo_mysql
extension=json
extension=curl
extension=mbstring
extension=openssl
extension=fileinfo
extension=tokenizer
extension=xml
extension=gd
extension=zip

# 时区设置
date.timezone = Asia/Shanghai
```

### 2. Nginx配置

创建配置文件：`/etc/nginx/sites-available/lottery`

```nginx
server {
    listen 80;
    server_name your-domain.com;  # 替换为您的域名
    root /path/to/新系统/public;  # 替换为实际路径
    index index.php index.html;

    # 前台配置
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    # 后台配置
    location /admin {
        try_files $uri $uri/ /admin.php?$query_string;
    }

    # PHP处理
    location ~ \.php$ {
        fastcgi_pass unix:/var/run/php/php8.1-fpm.sock;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
    }

    # WebSocket代理 (可选)
    location /ws/ {
        proxy_pass http://127.0.0.1:15531;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 静态文件缓存
    location ~* \.(css|js|png|jpg|jpeg|gif|ico|svg)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
```

启用配置：
```bash
sudo ln -s /etc/nginx/sites-available/lottery /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

### 3. MySQL数据库配置

```bash
# 登录MySQL
mysql -u root -p

# 创建数据库和用户
CREATE DATABASE shicai CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'lottery_user'@'localhost' IDENTIFIED BY 'your_strong_password';
GRANT ALL PRIVILEGES ON shicai.* TO 'lottery_user'@'localhost';
FLUSH PRIVILEGES;
EXIT;

# 导入数据库
cd /path/to/新系统
mysql -u lottery_user -p shicai < think_admin.sql
```

## 🚀 **系统部署**

### 1. 部署代码

```bash
# 进入Web根目录
cd /var/www/html

# 上传或克隆代码到此目录
# 假设代码在 /var/www/html/新系统

# 设置权限
sudo chown -R www-data:www-data /var/www/html/新系统
sudo chmod -R 755 /var/www/html/新系统
sudo chmod -R 777 /var/www/html/新系统/runtime
sudo chmod -R 777 /var/www/html/新系统/public
```

### 2. 配置数据库连接

编辑：`新系统/config/database.php`

```php
return [
    'default' => 'mysql',
    'connections' => [
        'mysql' => [
            'type'     => 'mysql',
            'hostname' => '127.0.0.1',
            'database' => 'shicai',
            'username' => 'lottery_user',
            'password' => 'your_strong_password',
            'hostport' => '3306',
            'charset'  => 'utf8mb4',
        ],
    ],
];
```

### 3. 安装依赖

```bash
cd /var/www/html/新系统
composer install --no-dev --optimize-autoloader
```

### 4. 启动系统

```bash
# 给启动脚本执行权限
chmod +x start_system.sh

# 启动系统
./start_system.sh start
```

## 🔍 **验证安装**

### 1. 检查PHP环境

```bash
# 检查PHP版本和扩展
php -v
php -m | grep -E "(mysql|pdo|json|curl|mbstring|openssl)"
```

### 2. 检查MySQL连接

```bash
# 测试数据库连接
mysql -u lottery_user -p shicai -e "SHOW TABLES;"
```

### 3. 检查Web服务

```bash
# 访问测试
curl -I http://your-domain.com
curl -I http://your-domain.com/admin
```

### 4. 检查WebSocket服务

```bash
# 查看进程
./start_system.sh status

# 检查端口
netstat -tulpn | grep -E "(8080|15531|15532|15533|15534|15535|15537|15538)"
```

## 🔒 **安全配置**

### 1. 防火墙配置

```bash
# Ubuntu/Debian
sudo ufw allow 22        # SSH
sudo ufw allow 80        # HTTP
sudo ufw allow 443       # HTTPS
sudo ufw allow 8080      # 应用端口
sudo ufw enable

# CentOS/RHEL
sudo firewall-cmd --permanent --add-port=80/tcp
sudo firewall-cmd --permanent --add-port=443/tcp
sudo firewall-cmd --permanent --add-port=8080/tcp
sudo firewall-cmd --reload
```

### 2. SSL证书 (推荐)

```bash
# 使用Let's Encrypt (免费)
sudo apt install certbot python3-certbot-nginx
sudo certbot --nginx -d your-domain.com
```

### 3. 系统优化

```bash
# 增加文件描述符限制
echo "* soft nofile 65535" >> /etc/security/limits.conf
echo "* hard nofile 65535" >> /etc/security/limits.conf

# PHP-FPM优化
sudo vim /etc/php/8.1/fpm/pool.d/www.conf
# 调整 pm.max_children, pm.start_servers, pm.min_spare_servers, pm.max_spare_servers
```

## 📱 **访问系统**

部署完成后，您可以通过以下地址访问：

- **前台**: http://your-domain.com
- **后台**: http://your-domain.com/admin
- **WebSocket游戏**: ws://your-domain.com:15531-15538

## 🛠️ **常用维护命令**

```bash
# 系统管理
./start_system.sh start     # 启动所有服务
./start_system.sh stop      # 停止所有服务
./start_system.sh status    # 查看服务状态
./start_system.sh restart   # 重启所有服务

# 日志查看
tail -f runtime/log/error.log     # 应用错误日志
tail -f /var/log/nginx/error.log  # Nginx错误日志
tail -f /var/log/mysql/error.log  # MySQL错误日志

# 性能监控
top                         # 系统资源监控
netstat -tulpn             # 端口监控
mysql -e "SHOW PROCESSLIST;" # 数据库连接监控
```

## 🆘 **常见问题解决**

### 1. PHP扩展缺失
```bash
# 检查并安装缺失扩展
php -m | grep extension_name
sudo apt install php8.1-extension_name
```

### 2. 数据库连接失败
```bash
# 检查MySQL服务状态
sudo systemctl status mysql
# 检查防火墙设置
# 验证数据库用户权限
```

### 3. WebSocket连接问题
```bash
# 检查端口是否被占用
netstat -tulpn | grep 15531
# 检查进程状态
ps aux | grep workerman
```

---

**按照以上步骤部署后，您的彩票系统就可以正常运行了！** 🎉